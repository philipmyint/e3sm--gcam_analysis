# e3sm--gcam_analysis
Scripts for plotting and analyzing outputs from coupled Energy Exascale Earth System Model ([E3SM](https://github.com/E3SM-Project/E3SM)) and Global Change Analysis Model ([GCAM](https://gcims.pnnl.gov/modeling/gcam-global-change-analysis-model)) simulations. The scripts can be run on a local machine (i.e., a personal laptop) as well as on DOE high-performance computing clusters like Chrysalis. The scripts are motivated by the desire to handle ensembles of E3SM--GCAM simulations generating many terabytes of data, and towards this purpose, they utilize vectorization and multiprocessing functions to enhance their computational efficiency. 

Author: Philip Myint, [myint1@llnl.gov](myint1@llnl.gov)

## Getting Started
### Overview of directories
- `scripts`: Contains the scripts, all but one of which is in Python, with the lone exception being in R. Each script can be run by entering `python [script_name].py [json_file].json` or `Rscript [script_name].R [json_file].json` on the command line. Here, the JSON file that is run together with script indicates user options for creating the plots or performing the analysis detailed in the script. The scripts can take in arbitrary number of JSON files specified through the command line, so the user options can be split up over multiple JSON files if desired. The user does not need to modify any of the scripts to run them; the intent is for them to modify only the corresponding JSON file(s). In addition, the `scripts` directory contains a number of utility files that provide auxiliary functions and variables (e.g., dictionaries) used by the main set of scripts. There is also a `docs` subdirectory that contains API documentation in the form of HTML files that are generated from docstrings in the Python scripts. These HTML files provide graphical API summaries, including information about the name, a brief description, input parameters, and return values/types of each function.

- `2025_DiVittorio_et_al_e3sm`: Contains data extracted from E3SM outputs. When running the scripts with the example JSON files included in this repository (see more details below), the plots and analysis files generated by those examples will appear in this directory as well. This directory already contains some files that have been extracted from E3SM outputs on Chrysalis using the scripts `e3sm_extract_spatial_data_h0.py`, `e3sm_extract_time_series_h0.py`, and `e3sm_extract_time_series_surfdata_iesm_dyn.py` scripts described further below. Specifically, the outputs are taken from earlier runs conducted on Chrysalis that will be published in an upcoming [2025 JAMES paper by DiVittorio et al](https://github.com/aldivi/E3SM-GCAM-JAMES-2024). The extracted outputs are included for convenience as part of the repo so that the examples are readily runnable on local machines or other DOE clusters, without the hassle of requiring the user to first extract the outputs on Chrysalis.

- `2025_DiVittorio_et_al_gcam`: Contains data extracted from GCAM outputs. Like with E3SM outputs, the GCAM directory already contains pre-extracted data and files from various outputs on Chrysalis, allowing the JSON examples to be runnable on other machines besides Chrysalis. This pre-extracted data include shape files and relevant geographical information on the GCAM regions and basins, a set of files containing soil and vegetation scalars from earlier runs in the Divittorio et al. JAMES paper, and a couple of project files extracted from GCAM XML files produced during the earlier runs. 

- `output_headers`: Contains text files for the headers of the different E3SM NetCDF file types used in this repo (for ease of reference).

- `scripts_from_others`: Contains Python and R scripts used for previous E3SM--GCAM analysis.

### Installation
Python is required to run the scripts. The e3sm_unified [Conda environment](https://docs.e3sm.org/e3sm_diags/_build/html/v2.10.1/install.html) that is available on machines like Chrysalis is sufficient. On other machines, the following libraries/modules/packages (plus additional dependencies) may need to be installed to supplement the base Python standard library:
- `geopandas`
- `matplotlib`
- `numpy`
- `pandas`
- `scipy`
- `seaborn`
- `uxarray`
- `xarray`

One of the scripts in the repo, `gcam_extract_csv_from_project_files.R`, is based on R. For this script, the following libraries and packages, plus their dependencies, must be installed:
- `devtools`
- `dplyr`
- `rgcam`
- `rjson`

Finally, one can optionally install LaTeX. The JSON examples in the repo assume that it has been installed so that LaTeX is used to typeset the axis labels, legends, and titles in the plots. However, the default option in the scripts is actually to not use LaTeX, so one can just delete the `use_latex: true` lines in the JSON files if LaTeX is not installed or not desired. Note that if installing LaTeX on a Linux/Unix machine like Chrysalis, root access is not required; one can follow the instructions [here](https://www.tug.org/texlive/quickinstall.html#running), and specifically follow the steps under `writable destination` to install LaTeX without needing root access.

## E3SM scripts
The following is a brief description of the scripts for plotting and analyzing E3SM output. To test out these scripts, run them on the command line with the JSON file(s). The JSON examples provided in the repo share the same name with their corresponding scripts.

### `e3sm_extract_time_series_h0.py`
Extracts time series data from E3SM-generated .h0 NetCDF files and puts the results into a .csv or fixed-width format tabular .dat file. Each of the NetCDF files contains E3SM output for a particular month and year of a simulation. Each block in a JSON file corresponds to a single .csv or .dat file, and one can specify in that block the start and end years for collecting the time series, the specific variables to extract from the NetCDF files, and whether additional processing is to be done on the time series. E3SM by default produces outputs in SI units, so that, for example, fluxes are in units of kg/m$^2$/s, but the additional processing changes the units to Pg/year, which is more amenable to interpreting fluxes on a global scale. The processing also adds new variables to the .csv or .dat files, such as the total precipitation rate and the near-ground mole fraction of CO$_2$ in dry air (i.e., with humidity subtracted out). By default, the script extracts data over the entire globe (over all latitude/longitudes), but the extraction can be limited to specific regions (e.g., North America, the Amazon, Southeast Asia) if desired by entering a line with the `regions` keyword, as demonstrated in a few of the JSON example blocks; see `utility_e3sm_netcdf.py` for a list of the available regions and the bounds on their latitude/longitude coordinates.

### `e3sm_extract_time_series_surfdata_iesm_dyn.py`
Works similarly to `e3sm_extract_time_series_h0.py`, but instead of extracting time series from the NetCDF h0 files, it extracts time series from NetCDF files generated dynamically during run time by the E3SM human component (EHC), where these files contain land surface data like areas for different landtypes (e.g., forest, grass, crop, shrub) and land utilizations (e.g., harvest, grazing).

### `e3sm_extract_spatial_data_h0.py`
Extracts data needed to make spatial plots from the NetCDF h0 files. Unlike the two other E3SM extraction scripts described above, this script produces a NetCDF file as its output for each block in a JSON file. This NetCDF file contains data between only the start and end years for the specific variables listed in the JSON block. Thus, the resulting file is typically much smaller and more manageable than the raw NetCDF files produced directly by E3SM. Additional processing to add variables like the total precipitation rate and the near-ground mole fraction of CO$_2$ in dry air are automatically performed, although unit conversions (e.g., from kg to Pg) are not performed since the spatial data will be visualized/analyzed on a per-gridcell basis instead of taken as an aggregate over the entire globe.

### `e3sm_plot_time_series.py`
Reads in the .csv or .dat files generated by the time series extraction scripts to produce a plot for each variable in the .csv/.dat files. The user can list the specific variable that they want to make plots for in the JSON files, but if no variables are specified, then a time series plot will be generated for every variable in the .csv/.dat file. Plotting options can be customized for each variable so that, for example, if a line in the JSON file reads `"y_label": {"ZCO2": "CO$_2$ concentration (ppm)", "SFCO2": "CO$_2$ surface flux (Pg C/month)"}`, the indicated y-axis labels will be used for the ZCO2 and SFCO2 plots, but a default y-axis label will be used for the plots of all other variables. A single keyword option with no variable name attached to it means that the default will be overriden for all variables. For example, the line `"use_latex": true` that is present in the example JSON files means that LaTeX will be used to generate the text in the plots of all the variables, overriding the default to not use LaTeX. In this script, and in all of the other plotting scripts described below, there is a dictionary defined near the top of the script that displays the different possible keyword options and the default values for these options. By putting the 

```
"output_files": [
            ["./../2025_DiVittorio_et_al_e3sm/control_time_series.dat", "./../2025_DiVittorio_et_al_e3sm/full_feedback_time_series.dat",
            "./../2025_DiVittorio_et_al_e3sm/ag_scaling_time_series.dat", "./../2025_DiVittorio_et_al_e3sm/carbon_scaling_time_series.dat"],
            ["./../2025_DiVittorio_et_al_e3sm/control_time_series_2.dat", "./../2025_DiVittorio_et_al_e3sm/full_feedback_time_series_2.dat",
            "./../2025_DiVittorio_et_al_e3sm/ag_scaling_time_series_2.dat", "./../2025_DiVittorio_et_al_e3sm/carbon_scaling_time_series_2.dat"],
            ["./../2025_DiVittorio_et_al_e3sm/control_time_series_3.dat", "./../2025_DiVittorio_et_al_e3sm/full_feedback_time_series_3.dat",
            "./../2025_DiVittorio_et_al_e3sm/ag_scaling_time_series_3.dat", "./../2025_DiVittorio_et_al_e3sm/carbon_scaling_time_series_3.dat"],
            ["./../2025_DiVittorio_et_al_e3sm/control_time_series_4.dat", "./../2025_DiVittorio_et_al_e3sm/full_feedback_time_series_4.dat",
            "./../2025_DiVittorio_et_al_e3sm/ag_scaling_time_series_4.dat", "./../2025_DiVittorio_et_al_e3sm/carbon_scaling_time_series_4.dat"],
            ["./../2025_DiVittorio_et_al_e3sm/control_time_series_5.dat", "./../2025_DiVittorio_et_al_e3sm/full_feedback_time_series_5.dat",
            "./../2025_DiVittorio_et_al_e3sm/ag_scaling_time_series_5.dat", "./../2025_DiVittorio_et_al_e3sm/carbon_scaling_time_series_5.dat"]
],
```

### `e3sm_produce_synthetic_spatial_data.py` and `e3sm_produce_synthetic_time_series.py`
Produces synthetic spatial data and time series sets by applying random numbers to existing NetCDF (for spatial data) or .csv/.dat (for time series) files. The intent is to create a synthetic ensemble of simulations, so that one can then test out the plotting and analysis capabilities of the scripts on ensembles. Unlike the other scripts described above, example JSON files are not provided for `e3sm_produce_synthetic_spatial_data.py` and `e3sm_produce_synthetic_time_series.py`, since they are not intended to be used in a real situation where an actual ensemble of simulation data are available. As a result, any desired changes will have to be made to the Python scripts themselves.

### TODO:
- Extraction of time series and spatial data from h0 files if the h0 files are printed out at arbitrary time intervals (not just months like in the currently available set of outputs on Chrysalis). 
- Add ability to plot spatial distribution of plant functional type (PFT) categories---including both individual types and aggregated subgroups like forest, shrub, grass---and land unit types (e.g., vegetation fraction). Right now, the scripts can only make time series plots of PFT categories and land unit types.
- Stippling is currently restricted to ELM spatial plots; add capability to plot stippling for 

## GCAM scripts
The following is a brief description of the scripts for plotting and analyzing GCAM output. To test out these scripts, run them on the command line with the JSON file(s). The JSON examples provided in the repo share the same name with their corresponding scripts.

